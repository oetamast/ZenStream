<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">History</h1>
    <p class="text-gray-400 text-sm">Recent events and session logs.</p>
  </div>
  <button id="refreshHistory" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Refresh</button>
</div>

<div id="historyEmpty" class="hidden text-gray-400 text-sm">No events yet.</div>
<div id="historyList" class="space-y-3"></div>

<script>
  const historyList = document.getElementById('historyList');
  const historyEmpty = document.getElementById('historyEmpty');

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  function safeMeta(raw) {
    if (!raw) return {};
    if (typeof raw === 'object') return raw;
    try { return JSON.parse(raw); } catch (e) { return {}; }
  }

  function renderEvent(ev) {
    const meta = safeMeta(ev.metadata_json);
    const logLink = ev.session_id ? `<button class="text-blue-400 text-sm" onclick="downloadLog('${ev.session_id}')">View log</button>` : '';
    return `<div class="bg-dark-800 border border-gray-700 rounded-lg p-3">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">${ev.event_type}</div>
          <div class="text-xs text-gray-300">${ev.message || ''}</div>
          ${meta.details ? `<div class="text-xs text-gray-400">${meta.details}</div>` : ''}
        </div>
        <div class="text-xs text-gray-400">${new Date(ev.created_at).toLocaleString()}</div>
      </div>
      ${logLink}
    </div>`;
  }

  async function loadHistory() {
    const data = await fetchJson('/api/history?limit=50');
    const events = data.events || [];
    historyEmpty.classList.toggle('hidden', events.length > 0);
    historyList.innerHTML = events.map(renderEvent).join('');
  }

  async function downloadLog(sessionId) {
    const res = await fetch(`/api/history/sessions/${sessionId}/log`);
    if (!res.ok) return alert('Log not found');
    const text = await res.text();
    const win = window.open('', '_blank');
    win.document.write(`<pre>${text.replace(/</g,'&lt;')}</pre>`);
    win.document.close();
  }

  document.getElementById('refreshHistory').onclick = loadHistory;
  loadHistory();
</script>
