<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">Presets</h1>
    <p class="text-gray-400 text-sm">Choose copy/remux or encode settings for FFmpeg.</p>
  </div>
  <button id="refreshPresets" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Refresh</button>
</div>

<div class="bg-dark-800 border border-gray-700 rounded-lg p-4 mb-6">
  <h2 class="font-semibold mb-3">Create preset</h2>
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm mb-1">Name</label>
      <input id="presetName" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="Copy/Remux" />
    </div>
    <div>
      <label class="block text-sm mb-1">Mode</label>
      <select id="presetMode" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="copy">Copy / Remux</option>
        <option value="encode">Encode</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Video codec (encode mode)</label>
      <input id="presetVideo" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="libx264" />
    </div>
    <div>
      <label class="block text-sm mb-1">Audio codec (encode mode)</label>
      <input id="presetAudio" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="aac" />
    </div>
  </div>
  <div class="mt-4 flex justify-end">
    <button id="createPreset" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
  </div>
  <p id="presetError" class="text-red-400 text-sm mt-2 hidden"></p>
</div>

<div id="presetEmpty" class="hidden text-gray-400 text-sm">No presets defined.</div>
<div id="presetList" class="space-y-3"></div>

<div id="presetDeleteModal" class="hidden fixed inset-0 bg-black/70 z-40 items-center justify-center p-4">
  <div class="bg-dark-800 border border-gray-700 rounded-lg w-full max-w-lg p-5 space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Delete preset</h3>
      <button id="closePresetDelete" class="text-gray-400 hover:text-white"><i class="ti ti-x"></i></button>
    </div>
    <p class="text-sm text-red-300">Deleting this preset will disable impacted streams until you pick another preset.</p>
    <div class="bg-dark-700 border border-gray-600 rounded p-2 max-h-40 overflow-auto text-sm" id="presetImpactList"></div>
    <label class="inline-flex items-center gap-2 text-sm">
      <input type="checkbox" id="presetDeleteConfirm" class="accent-primary" />
      I understand and want to delete this preset.
    </label>
    <p id="presetDeleteError" class="hidden text-red-400 text-sm"></p>
    <div class="flex justify-end gap-3">
      <button id="cancelPresetDelete" class="bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
      <button id="confirmPresetDelete" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">Delete</button>
    </div>
  </div>
</div>

<script>
  const presetList = document.getElementById('presetList');
  const presetEmpty = document.getElementById('presetEmpty');

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  async function loadPresets() {
    const data = await fetchJson('/api/presets');
    const presets = data.presets || [];
    presetEmpty.classList.toggle('hidden', presets.length > 0);
    presetList.innerHTML = presets.map(renderPreset).join('');
  }

  function renderPreset(preset) {
    const mode = preset.force_encode ? 'Encode' : 'Copy/Remux';
    return `<div class="bg-dark-800 border border-gray-700 rounded-lg p-3 flex items-center justify-between">
      <div>
        <div class="font-semibold">${preset.name}</div>
        <div class="text-xs text-gray-400">${mode}${preset.video_codec ? ` â€¢ ${preset.video_codec}` : ''}${preset.audio_codec ? ` / ${preset.audio_codec}` : ''}</div>
      </div>
      <button class="text-sm text-red-400" onclick="openPresetDelete('${preset.id}')">Delete</button>
    </div>`;
  }

  async function createPreset() {
    presetError.classList.add('hidden');
    const mode = document.getElementById('presetMode').value;
    const body = {
      name: document.getElementById('presetName').value,
      remux_enabled: mode === 'copy',
      force_encode: mode === 'encode',
      video_codec: document.getElementById('presetVideo').value || null,
      audio_codec: document.getElementById('presetAudio').value || null,
    };
    try {
      await fetchJson('/api/presets', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      await loadPresets();
    } catch (err) {
      presetError.textContent = err.message;
      presetError.classList.remove('hidden');
    }
  }

  const presetDeleteModal = document.getElementById('presetDeleteModal');
  let presetDeleteId = null;

  async function openPresetDelete(id) {
    presetDeleteId = id;
    document.getElementById('presetDeleteConfirm').checked = false;
    document.getElementById('presetDeleteError').classList.add('hidden');
    const listEl = document.getElementById('presetImpactList');
    listEl.innerHTML = 'Loading impacted streams...';
    presetDeleteModal.classList.remove('hidden');
    const data = await fetchJson(`/api/presets/${id}/impacted-jobs`).catch(() => ({ impacted_jobs: [], total: 0 }));
    const items = data.impacted_jobs || [];
    const extra = data.total && data.total > items.length ? data.total - items.length : 0;
    listEl.innerHTML = items.length
      ? `<ul class="list-disc list-inside space-y-1">${items.map((j) => `<li>${j.name}</li>`).join('')}</ul>${extra ? `<div class=\"text-xs text-gray-400 mt-1\">+${extra} more</div>` : ''}`
      : '<div class="text-gray-400 text-sm">No impacted streams.</div>';
  }

  async function deletePreset() {
    const errEl = document.getElementById('presetDeleteError');
    if (!document.getElementById('presetDeleteConfirm').checked) {
      errEl.textContent = 'Please confirm deletion.';
      errEl.classList.remove('hidden');
      return;
    }
    try {
      await fetchJson(`/api/presets/${presetDeleteId}?force=true`, { method: 'DELETE' });
      presetDeleteModal.classList.add('hidden');
      await loadPresets();
    } catch (err) {
      errEl.textContent = err.message;
      errEl.classList.remove('hidden');
    }
  }

  document.getElementById('createPreset').onclick = createPreset;
  document.getElementById('refreshPresets').onclick = loadPresets;
  document.getElementById('confirmPresetDelete').onclick = deletePreset;
  document.getElementById('cancelPresetDelete').onclick = () => presetDeleteModal.classList.add('hidden');
  document.getElementById('closePresetDelete').onclick = () => presetDeleteModal.classList.add('hidden');
  loadPresets();
</script>
