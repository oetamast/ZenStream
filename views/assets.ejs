<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">Assets</h1>
    <p class="text-gray-400 text-sm">Upload or import media to use in streams.</p>
  </div>
  <div class="flex gap-2">
    <input id="assetQuery" placeholder="Search filename" class="bg-dark-700 border border-gray-600 rounded px-3 py-2" />
    <select id="assetFilter" class="bg-dark-700 border border-gray-600 rounded px-3 py-2">
      <option value="">All</option>
      <option value="video">Video</option>
      <option value="audio">Audio</option>
      <option value="sfx">SFX</option>
    </select>
    <button id="refreshAssets" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Refresh</button>
  </div>
</div>

<div class="bg-dark-800 border border-gray-700 rounded-lg p-4 mb-6">
  <h2 class="font-semibold mb-3">Upload asset</h2>
  <div class="grid md:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm mb-1">File</label>
      <input id="assetFile" type="file" class="w-full text-sm" />
    </div>
    <div>
      <label class="block text-sm mb-1">Type</label>
      <select id="assetType" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="video">Video</option>
        <option value="audio">Audio</option>
        <option value="sfx">SFX</option>
      </select>
    </div>
    <div class="flex items-end">
      <button id="uploadAsset" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Upload</button>
    </div>
  </div>
  <p class="text-xs text-gray-400 mt-2">Max 500MB. Thumbnails are generated for video files.</p>
  <p id="assetError" class="text-red-400 text-sm mt-2 hidden"></p>
</div>

<div id="assetsEmpty" class="hidden text-gray-400 text-sm">No assets found.</div>
<div id="assetsGrid" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

<div id="assetDeleteModal" class="hidden fixed inset-0 bg-black/70 z-40 items-center justify-center p-4">
  <div class="bg-dark-800 border border-gray-700 rounded-lg w-full max-w-lg p-5 space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Delete asset</h3>
      <button id="closeAssetDelete" class="text-gray-400 hover:text-white"><i class="ti ti-x"></i></button>
    </div>
    <p class="text-sm text-red-300">Deleting this asset will disable impacted streams until you pick another asset.</p>
    <div class="bg-dark-700 border border-gray-600 rounded p-2 max-h-40 overflow-auto text-sm" id="assetImpactList"></div>
    <label class="inline-flex items-center gap-2 text-sm">
      <input type="checkbox" id="assetDeleteConfirm" class="accent-primary" />
      I understand and want to delete this asset.
    </label>
    <p id="assetDeleteError" class="hidden text-red-400 text-sm"></p>
    <div class="flex justify-end gap-3">
      <button id="cancelAssetDelete" class="bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
      <button id="confirmAssetDelete" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">Delete</button>
    </div>
  </div>
</div>

<script>
  const assetsGrid = document.getElementById('assetsGrid');
  const assetsEmpty = document.getElementById('assetsEmpty');

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  async function loadAssets() {
    const params = new URLSearchParams();
    const filter = document.getElementById('assetFilter').value;
    const query = document.getElementById('assetQuery').value;
    if (filter) params.set('type', filter);
    if (query) params.set('query', query);
    const data = await fetchJson('/api/assets' + (params.toString() ? `?${params}` : ''));
    const assets = data.assets || [];
    assetsEmpty.classList.toggle('hidden', assets.length > 0);
    assetsGrid.innerHTML = assets.map(renderAsset).join('');
  }

  function safeMeta(raw) {
    if (!raw) return {};
    if (typeof raw === 'object') return raw;
    try { return JSON.parse(raw); } catch (e) { return {}; }
  }

  function renderAsset(asset) {
    const meta = safeMeta(asset.metadata_json);
    const durationLabel = meta.format?.duration || meta.duration;
    return `<div class="bg-dark-800 border border-gray-700 rounded-lg p-3 flex gap-3">
      <div class="w-28 h-20 bg-dark-700 rounded overflow-hidden flex items-center justify-center">
        ${asset.thumbnail_path ? `<img src="/api/assets/${asset.id}/thumbnail" class="object-cover w-full h-full" />` : '<span class="text-gray-500 text-xs">No thumbnail</span>'}
      </div>
      <div class="flex-1">
        <div class="font-semibold">${asset.filename}</div>
        <div class="text-xs text-gray-400">${asset.type} â€¢ ${((asset.size_bytes || 0)/1_000_000).toFixed(1)} MB</div>
        ${durationLabel ? `<div class="text-xs text-gray-400">Duration: ${Number(durationLabel).toFixed(1)}s</div>` : ''}
        <div class="text-xs text-gray-500">Created: ${new Date(asset.created_at).toLocaleString()}</div>
        <div class="mt-2 flex gap-2">
          <button class="text-sm text-blue-400" onclick="analyzeAsset('${asset.id}')">Analyze</button>
          <button class="text-sm text-red-400" onclick="openAssetDelete('${asset.id}', '${asset.filename}')">Delete</button>
        </div>
      </div>
    </div>`;
  }

  async function analyzeAsset(id) {
    await fetchJson(`/api/assets/${id}/analyze`, { method: 'POST' });
    await loadAssets();
  }

  async function uploadAsset() {
    assetError.classList.add('hidden');
    const file = document.getElementById('assetFile').files[0];
    if (!file) {
      assetError.textContent = 'Choose a file first';
      assetError.classList.remove('hidden');
      return;
    }
    const type = document.getElementById('assetType').value;
    const form = new FormData();
    form.append('file', file);
    form.append('asset_type', type);
    try {
      await fetchJson('/api/assets/upload', { method: 'POST', body: form });
      document.getElementById('assetFile').value = '';
      await loadAssets();
    } catch (err) {
      assetError.textContent = err.message;
      assetError.classList.remove('hidden');
    }
  }

  document.getElementById('uploadAsset').onclick = uploadAsset;
  document.getElementById('refreshAssets').onclick = loadAssets;
  document.getElementById('assetQuery').oninput = () => loadAssets();
  document.getElementById('assetFilter').onchange = () => loadAssets();

  const assetDeleteModal = document.getElementById('assetDeleteModal');
  let assetDeleteTarget = null;

  async function openAssetDelete(id) {
    assetDeleteTarget = id;
    document.getElementById('assetDeleteConfirm').checked = false;
    document.getElementById('assetDeleteError').classList.add('hidden');
    const listEl = document.getElementById('assetImpactList');
    listEl.innerHTML = 'Loading impacted streams...';
    assetDeleteModal.classList.remove('hidden');
    const data = await fetchJson(`/api/assets/${id}/impacted-jobs`).catch(() => ({ impacted_jobs: [], total: 0 }));
    const items = data.impacted_jobs || [];
    const extra = data.total && data.total > items.length ? data.total - items.length : 0;
    listEl.innerHTML = items.length
      ? `<ul class="list-disc list-inside space-y-1">${items.map((j) => `<li>${j.name}</li>`).join('')}</ul>${extra ? `<div class=\"text-xs text-gray-400 mt-1\">+${extra} more</div>` : ''}`
      : '<div class="text-gray-400 text-sm">No impacted streams.</div>';
  }

  async function confirmAssetDelete() {
    const checkbox = document.getElementById('assetDeleteConfirm');
    const errorEl = document.getElementById('assetDeleteError');
    if (!checkbox.checked) {
      errorEl.textContent = 'Please acknowledge the warning to delete this asset.';
      errorEl.classList.remove('hidden');
      return;
    }
    try {
      await fetchJson(`/api/assets/${assetDeleteTarget}?force=true`, { method: 'DELETE' });
      assetDeleteModal.classList.add('hidden');
      await loadAssets();
    } catch (err) {
      errorEl.textContent = err.message;
      errorEl.classList.remove('hidden');
    }
  }

  document.getElementById('confirmAssetDelete').onclick = confirmAssetDelete;
  document.getElementById('cancelAssetDelete').onclick = () => assetDeleteModal.classList.add('hidden');
  document.getElementById('closeAssetDelete').onclick = () => assetDeleteModal.classList.add('hidden');

  loadAssets();
</script>
