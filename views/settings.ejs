<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">Settings</h1>
    <p class="text-gray-400 text-sm">Timezone, language, and retention.</p>
  </div>
</div>

<div class="bg-dark-800 border border-gray-700 rounded-lg p-4">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm mb-1">Timezone</label>
      <select id="settingTimezone" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="UTC">UTC</option>
        <option value="Asia/Jakarta">Asia/Jakarta</option>
        <option value="America/New_York">America/New_York</option>
        <option value="Europe/London">Europe/London</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Language</label>
      <select id="settingLanguage" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="en">English</option>
        <option value="id">Bahasa Indonesia</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Retention days</label>
      <input id="settingRetention" type="number" min="1" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" />
    </div>
    <div class="flex items-center gap-2">
      <input id="settingForever" type="checkbox" class="accent-primary" />
      <span class="text-sm">Keep forever</span>
    </div>
  </div>
  <div class="mt-4 flex items-center justify-between">
    <div class="text-gray-500 text-sm">Telegram toggles coming soon.</div>
    <button id="saveSettings" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
  </div>
  <p id="settingsMsg" class="text-sm mt-2 hidden"></p>
</div>

<script>
  const tz = document.getElementById('settingTimezone');
  const lang = document.getElementById('settingLanguage');
  const retention = document.getElementById('settingRetention');
  const forever = document.getElementById('settingForever');
  const msg = document.getElementById('settingsMsg');

  function updateRetentionState() {
    const disableRetention = forever.checked;
    retention.disabled = disableRetention;
    retention.classList.toggle('opacity-60', disableRetention);
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  async function loadSettings() {
    const data = await fetchJson('/api/settings');
    const s = data.settings || {};
    tz.value = s.timezone || 'UTC';
    lang.value = s.language || 'en';
    retention.value = s.retention_days || 30;
    forever.checked = Boolean(s.keep_forever);
    updateRetentionState();
  }

  async function saveSettings() {
    msg.classList.add('hidden');
    try {
      await fetchJson('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          timezone: tz.value,
          language: lang.value,
          retention_days: Number(retention.value || 30),
          keep_forever: forever.checked,
        }),
      });
      msg.textContent = 'Saved';
      msg.classList.remove('hidden');
      msg.classList.remove('text-red-400');
      msg.classList.add('text-green-400');
    } catch (err) {
      msg.textContent = err.message;
      msg.classList.remove('hidden');
      msg.classList.remove('text-green-400');
      msg.classList.add('text-red-400');
    }
  }

  document.getElementById('saveSettings').onclick = saveSettings;
  forever.addEventListener('change', updateRetentionState);
  loadSettings();
</script>
