<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">Settings</h1>
    <p class="text-gray-400 text-sm">Timezone, language, retention, and alerts.</p>
  </div>
</div>

<div class="bg-dark-800 border border-gray-700 rounded-lg p-4">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm mb-1">Timezone</label>
      <select id="settingTimezone" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="UTC">UTC</option>
        <option value="Asia/Jakarta">Asia/Jakarta</option>
        <option value="America/New_York">America/New_York</option>
        <option value="Europe/London">Europe/London</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Language</label>
      <select id="settingLanguage" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="en">English</option>
        <option value="id">Bahasa Indonesia</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Retention days</label>
      <input id="settingRetention" type="number" min="1" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" />
    </div>
    <div class="flex items-center gap-2">
      <input id="settingForever" type="checkbox" class="accent-primary" />
      <span class="text-sm">Keep forever</span>
    </div>
  </div>
  <div class="mt-6 border-t border-gray-700 pt-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="font-semibold">Telegram alerts</h2>
        <p class="text-gray-400 text-sm">Configure bot token, chat ID, and which events send messages.</p>
      </div>
      <label class="flex items-center gap-2 text-sm">
        <input id="telegramEnabled" type="checkbox" class="accent-primary" />
        <span>Enable Telegram</span>
      </label>
    </div>
    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm mb-1">Bot token</label>
        <div class="flex items-center gap-2">
          <input id="telegramToken" type="password" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="123456:ABC..." />
          <button id="toggleToken" type="button" class="text-sm px-3 py-2 bg-dark-700 border border-gray-600 rounded">Show</button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Stored securely; masked in future loads.</p>
      </div>
      <div>
        <label class="block text-sm mb-1">Chat ID</label>
        <input id="telegramChat" type="text" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="@channel or numeric chat id" />
      </div>
    </div>
    <div class="mt-4">
      <p class="text-sm font-semibold mb-2">Events</p>
      <div id="telegramEvents" class="grid md:grid-cols-2 gap-2"></div>
    </div>
    <div class="mt-4 flex items-center gap-3">
      <button id="testTelegram" type="button" class="bg-dark-700 border border-gray-600 text-white px-4 py-2 rounded">Send test</button>
      <p id="telegramMsg" class="text-sm hidden"></p>
    </div>
  </div>
  <div class="mt-4 flex items-center justify-between">
    <div class="text-gray-500 text-sm">Retention and Telegram settings are saved together.</div>
    <button id="saveSettings" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
  </div>
  <p id="settingsMsg" class="text-sm mt-2 hidden"></p>
</div>

<script>
  const tz = document.getElementById('settingTimezone');
  const lang = document.getElementById('settingLanguage');
  const retention = document.getElementById('settingRetention');
  const forever = document.getElementById('settingForever');
  const msg = document.getElementById('settingsMsg');
  const telegramEnabled = document.getElementById('telegramEnabled');
  const telegramToken = document.getElementById('telegramToken');
  const telegramChat = document.getElementById('telegramChat');
  const telegramEventsWrap = document.getElementById('telegramEvents');
  const telegramMsg = document.getElementById('telegramMsg');
  const toggleTokenBtn = document.getElementById('toggleToken');
  const EVENT_LABELS = {
    stream_start: 'Stream start',
    stream_stop: 'Stream stop (manual)',
    stream_fail: 'Stream failed',
    retry_gave_up: 'Retry gave up',
    license_fail: 'License fail',
    license_grace_started: 'License grace started',
    license_grace_ended: 'License grace ended',
  };
  let telegramEventsState = {};

  function updateRetentionState() {
    const disableRetention = forever.checked;
    retention.disabled = disableRetention;
    retention.classList.toggle('opacity-60', disableRetention);
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  async function loadSettings() {
    const data = await fetchJson('/api/settings');
    const s = data.settings || {};
    tz.value = s.timezone || 'UTC';
    lang.value = s.language || 'en';
    retention.value = s.retention_days || 30;
    forever.checked = Boolean(s.keep_forever);
    updateRetentionState();
    telegramEnabled.checked = Boolean(s.telegram_enabled);
    telegramChat.value = s.telegram_chat_id || '';
    telegramToken.value = '';
    telegramToken.placeholder = s.telegram_bot_token_masked || '';
    telegramEventsState = s.telegram_events || {};
    renderEventToggles();
  }

  async function saveSettings() {
    msg.classList.add('hidden');
    telegramMsg.classList.add('hidden');
    try {
      await fetchJson('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          timezone: tz.value,
          language: lang.value,
          retention_days: Number(retention.value || 30),
          keep_forever: forever.checked,
          telegram_enabled: telegramEnabled.checked,
          telegram_chat_id: telegramChat.value,
          telegram_bot_token: telegramToken.value || undefined,
          telegram_events: telegramEventsState,
        }),
      });
      msg.textContent = 'Saved';
      msg.classList.remove('hidden');
      msg.classList.remove('text-red-400');
      msg.classList.add('text-green-400');
      telegramToken.value = '';
    } catch (err) {
      msg.textContent = err.message;
      msg.classList.remove('hidden');
      msg.classList.remove('text-green-400');
      msg.classList.add('text-red-400');
    }
  }

  function renderEventToggles() {
    telegramEventsWrap.innerHTML = '';
    Object.entries(EVENT_LABELS).forEach(([key, label]) => {
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 text-sm';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'accent-primary';
      cb.checked = Boolean(telegramEventsState[key]);
      cb.onchange = () => {
        telegramEventsState[key] = cb.checked;
      };
      row.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = label;
      row.appendChild(span);
      telegramEventsWrap.appendChild(row);
    });
  }

  toggleTokenBtn.addEventListener('click', () => {
    const showing = telegramToken.type === 'text';
    telegramToken.type = showing ? 'password' : 'text';
    toggleTokenBtn.textContent = showing ? 'Show' : 'Hide';
  });

  document.getElementById('testTelegram').addEventListener('click', async () => {
    telegramMsg.classList.add('hidden');
    telegramMsg.classList.remove('text-green-400', 'text-red-400');
    try {
      await fetchJson('/api/settings/telegram/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_bot_token: telegramToken.value || undefined,
          telegram_chat_id: telegramChat.value || undefined,
        }),
      });
      telegramMsg.textContent = 'Test message sent.';
      telegramMsg.classList.add('text-green-400');
    } catch (err) {
      telegramMsg.textContent = err.message;
      telegramMsg.classList.add('text-red-400');
    }
    telegramMsg.classList.remove('hidden');
  });

  document.getElementById('saveSettings').onclick = saveSettings;
  forever.addEventListener('change', updateRetentionState);
  loadSettings();
</script>
