<% layout('layout') -%>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">Settings</h1>
    <p class="text-gray-400 text-sm">Timezone, language, retention, and alerts.</p>
  </div>
</div>

<div class="bg-dark-800 border border-gray-700 rounded-lg p-4">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm mb-1">License tier</label>
      <select id="licenseTier" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="basic">Basic</option>
        <option value="premium">Premium</option>
        <option value="ultimate">Ultimate</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">Licensing server comes later. This is a local stub for development.</p>
      <p class="text-xs text-gray-400 mt-1">Basic runs without retry; Premium/Ultimate retry within the schedule/run window.</p>
    </div>
    <div>
      <label class="block text-sm mb-1">Timezone</label>
      <select id="settingTimezone" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="UTC">UTC</option>
        <option value="Asia/Jakarta">Asia/Jakarta</option>
        <option value="America/New_York">America/New_York</option>
        <option value="Europe/London">Europe/London</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Language</label>
      <select id="settingLanguage" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2">
        <option value="en">English</option>
        <option value="id">Bahasa Indonesia</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Retention days</label>
      <input id="settingRetention" type="number" min="1" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" />
    </div>
    <div class="flex items-center gap-2">
      <input id="settingForever" type="checkbox" class="accent-primary" />
      <span class="text-sm">Keep forever</span>
    </div>
  </div>
  <div class="mt-6 border-t border-gray-700 pt-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="font-semibold">Telegram alerts</h2>
        <p class="text-gray-400 text-sm">Configure bot token, chat ID, and which events send messages.</p>
      </div>
      <label class="flex items-center gap-2 text-sm">
        <input id="telegramEnabled" type="checkbox" class="accent-primary" />
        <span>Enable Telegram</span>
      </label>
    </div>
    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm mb-1">Bot token</label>
        <div class="flex items-center gap-2">
          <input id="telegramToken" type="password" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="123456:ABC..." />
          <button id="toggleToken" type="button" class="text-sm px-3 py-2 bg-dark-700 border border-gray-600 rounded">Show</button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Stored securely; masked in future loads.</p>
      </div>
      <div>
        <label class="block text-sm mb-1">Chat ID</label>
        <input id="telegramChat" type="text" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="@channel or numeric chat id" />
      </div>
    </div>
    <div class="mt-4">
      <p class="text-sm font-semibold mb-2">Events</p>
      <div id="telegramEvents" class="grid md:grid-cols-2 gap-2"></div>
    </div>
    <div class="mt-4 flex items-center gap-3">
      <button id="testTelegram" type="button" class="bg-dark-700 border border-gray-600 text-white px-4 py-2 rounded">Send test</button>
      <p id="telegramMsg" class="text-sm hidden"></p>
    </div>
  </div>
  <div class="mt-6 border-t border-gray-700 pt-4 grid md:grid-cols-2 gap-4">
    <div class="p-3 rounded border border-gray-700 bg-dark-700/50">
      <h3 class="font-semibold">Premium-only controls</h3>
      <p class="text-xs text-gray-400 mb-2">Audio replace, auto-recovery, and hot swap are locked until Premium.</p>
      <div class="space-y-2 text-sm text-gray-400">
        <label class="flex items-center gap-2 opacity-60">
          <input type="checkbox" disabled class="accent-primary" />
          <span>Audio Replace (Coming soon)</span>
        </label>
        <label class="flex items-center gap-2 opacity-60">
          <input type="checkbox" disabled class="accent-primary" />
          <span>Auto-Recovery (Coming soon)</span>
        </label>
        <label class="flex items-center gap-2 opacity-60">
          <input type="checkbox" disabled class="accent-primary" />
          <span>Hot Swap (Coming soon)</span>
        </label>
        <p class="text-xs text-gray-500">Requires Premium tier.</p>
      </div>
    </div>
    <div class="p-3 rounded border border-gray-700 bg-dark-700/50">
      <h3 class="font-semibold">Ultimate-only controls</h3>
      <p class="text-xs text-gray-400 mb-2">Scenes and recurring swap rules will unlock with Ultimate.</p>
      <div class="space-y-2 text-sm text-gray-400">
        <label class="flex items-center gap-2 opacity-60">
          <input type="checkbox" disabled class="accent-primary" />
          <span>Scenes (Coming soon)</span>
        </label>
        <label class="flex items-center gap-2 opacity-60">
          <input type="checkbox" disabled class="accent-primary" />
          <span>Recurring Swap Rules (Coming soon)</span>
        </label>
        <p class="text-xs text-gray-500">Requires Ultimate tier.</p>
      </div>
    </div>
  </div>
  <div class="mt-6 border-t border-gray-700 pt-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="font-semibold">Google Drive</h2>
        <p class="text-gray-400 text-sm">Save OAuth client details to import assets from Drive.</p>
      </div>
      <p id="googleStatus" class="text-sm text-gray-400">Status: not configured</p>
    </div>
    <div class="grid md:grid-cols-3 gap-4 mt-3">
      <div>
        <label class="block text-sm mb-1">Client ID</label>
        <input id="googleClientId" type="text" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm mb-1">Client secret</label>
        <input id="googleClientSecret" type="password" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="Stored securely" />
      </div>
      <div>
        <label class="block text-sm mb-1">Redirect URL</label>
        <input id="googleRedirect" type="text" class="w-full bg-dark-700 border border-gray-600 rounded px-3 py-2" placeholder="http://<host>:6969/api/assets/google-drive/auth/callback" />
      </div>
    </div>
    <div class="flex items-center gap-3 mt-3">
      <button id="startGoogleAuth" class="bg-dark-700 border border-gray-600 text-white px-4 py-2 rounded">Connect Google Drive</button>
      <p class="text-xs text-gray-500">Save client credentials first, then launch OAuth. Tokens are encrypted at rest.</p>
    </div>
  </div>
  <div class="mt-4 flex items-center justify-between">
    <div class="text-gray-500 text-sm">Retention and Telegram settings are saved together.</div>
    <button id="saveSettings" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
  </div>
  <p id="settingsMsg" class="text-sm mt-2 hidden"></p>
</div>

<script>
  const tz = document.getElementById('settingTimezone');
  const lang = document.getElementById('settingLanguage');
  const retention = document.getElementById('settingRetention');
  const forever = document.getElementById('settingForever');
  const licenseTier = document.getElementById('licenseTier');
  const msg = document.getElementById('settingsMsg');
  const telegramEnabled = document.getElementById('telegramEnabled');
  const telegramToken = document.getElementById('telegramToken');
  const telegramChat = document.getElementById('telegramChat');
  const telegramEventsWrap = document.getElementById('telegramEvents');
  const telegramMsg = document.getElementById('telegramMsg');
  const toggleTokenBtn = document.getElementById('toggleToken');
  const googleClientId = document.getElementById('googleClientId');
  const googleClientSecret = document.getElementById('googleClientSecret');
  const googleRedirect = document.getElementById('googleRedirect');
  const googleStatus = document.getElementById('googleStatus');
  const googleAuthBtn = document.getElementById('startGoogleAuth');
  const EVENT_LABELS = {
    stream_start: 'Stream start',
    stream_stop: 'Stream stop (manual)',
    stream_fail: 'Stream failed',
    retry_gave_up: 'Retry gave up',
    license_fail: 'License fail',
    license_grace_started: 'License grace started',
    license_grace_ended: 'License grace ended',
  };
  let telegramEventsState = {};

  function updateRetentionState() {
    const disableRetention = forever.checked;
    retention.disabled = disableRetention;
    retention.classList.toggle('opacity-60', disableRetention);
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Request failed');
    }
    return res.json();
  }

  function setGoogleStatusText(status) {
    if (!status) {
      googleStatus.textContent = 'Status: not configured';
      googleStatus.className = 'text-sm text-gray-400';
      return;
    }
    const parts = [];
    if (status.connected) {
      parts.push('Connected');
      googleStatus.className = 'text-sm text-green-400';
    } else if (status.configured) {
      parts.push('Configured');
      googleStatus.className = 'text-sm text-amber-300';
    } else {
      parts.push('Not configured');
      googleStatus.className = 'text-sm text-gray-400';
    }
    if (status.redirect_uri) parts.push(`Redirect: ${status.redirect_uri}`);
    googleStatus.textContent = `Status: ${parts.join(' â€¢ ')}`;
  }

  async function refreshGoogleStatus() {
    try {
      const status = await fetchJson('/api/assets/google-drive/auth/status');
      setGoogleStatusText(status);
    } catch (err) {
      setGoogleStatusText(null);
    }
  }

  async function loadSettings() {
    const data = await fetchJson('/api/settings');
    const s = data.settings || {};
    licenseTier.value = s.license_tier || 'basic';
    tz.value = s.timezone || 'UTC';
    lang.value = s.language || 'en';
    retention.value = s.retention_days || 30;
    forever.checked = Boolean(s.keep_forever);
    updateRetentionState();
    telegramEnabled.checked = Boolean(s.telegram_enabled);
    telegramChat.value = s.telegram_chat_id || '';
    telegramToken.value = '';
    telegramToken.placeholder = s.telegram_bot_token_masked || '';
    telegramEventsState = s.telegram_events || {};
    renderEventToggles();
    googleClientId.value = s.google_client_id || '';
    googleClientSecret.value = '';
    googleClientSecret.placeholder = s.google_client_secret_masked || 'Stored securely';
    googleRedirect.value = s.google_redirect_uri || '';
    setGoogleStatusText({ configured: Boolean(s.google_client_id && s.google_client_secret_masked), connected: Boolean(s.google_refresh_token_present), redirect_uri: s.google_redirect_uri });
  }

  async function saveSettings() {
    msg.classList.add('hidden');
    telegramMsg.classList.add('hidden');
    try {
      await fetchJson('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          timezone: tz.value,
          language: lang.value,
          retention_days: Number(retention.value || 30),
          keep_forever: forever.checked,
          license_tier: licenseTier.value,
          telegram_enabled: telegramEnabled.checked,
          telegram_chat_id: telegramChat.value,
          telegram_bot_token: telegramToken.value || undefined,
          telegram_events: telegramEventsState,
          google_client_id: googleClientId.value,
          google_client_secret: googleClientSecret.value || undefined,
          google_redirect_uri: googleRedirect.value,
        }),
      });
      msg.textContent = 'Saved';
      msg.classList.remove('hidden');
      msg.classList.remove('text-red-400');
      msg.classList.add('text-green-400');
      telegramToken.value = '';
      googleClientSecret.value = '';
      refreshGoogleStatus();
    } catch (err) {
      msg.textContent = err.message;
      msg.classList.remove('hidden');
      msg.classList.remove('text-green-400');
      msg.classList.add('text-red-400');
    }
  }

  function renderEventToggles() {
    telegramEventsWrap.innerHTML = '';
    Object.entries(EVENT_LABELS).forEach(([key, label]) => {
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 text-sm';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'accent-primary';
      cb.checked = Boolean(telegramEventsState[key]);
      cb.onchange = () => {
        telegramEventsState[key] = cb.checked;
      };
      row.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = label;
      row.appendChild(span);
      telegramEventsWrap.appendChild(row);
    });
  }

  toggleTokenBtn.addEventListener('click', () => {
    const showing = telegramToken.type === 'text';
    telegramToken.type = showing ? 'password' : 'text';
    toggleTokenBtn.textContent = showing ? 'Show' : 'Hide';
  });

  document.getElementById('testTelegram').addEventListener('click', async () => {
    telegramMsg.classList.add('hidden');
    telegramMsg.classList.remove('text-green-400', 'text-red-400');
    try {
      await fetchJson('/api/settings/telegram/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_bot_token: telegramToken.value || undefined,
          telegram_chat_id: telegramChat.value || undefined,
        }),
      });
      telegramMsg.textContent = 'Test message sent.';
      telegramMsg.classList.add('text-green-400');
    } catch (err) {
      telegramMsg.textContent = err.message;
      telegramMsg.classList.add('text-red-400');
    }
    telegramMsg.classList.remove('hidden');
  });

  googleAuthBtn.addEventListener('click', async () => {
    googleStatus.textContent = 'Status: launching browser flow...';
    try {
      const data = await fetchJson('/api/assets/google-drive/auth/start', { method: 'POST' });
      window.open(data.authUrl, '_blank');
      googleStatus.textContent = 'Status: waiting for OAuth completion...';
      setTimeout(refreshGoogleStatus, 5000);
    } catch (err) {
      googleStatus.textContent = `Status: ${err.message}`;
      googleStatus.className = 'text-sm text-red-400';
    }
  });

  document.getElementById('saveSettings').onclick = saveSettings;
  forever.addEventListener('change', updateRetentionState);
  loadSettings();
  refreshGoogleStatus();
</script>
